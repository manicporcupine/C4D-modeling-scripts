# Align Points (Spline or Polygon) on X, then Y, then Z within a threshold
# Groups consider ALL points; when selection exists:
#   - move ONLY selected points,
#   - group center = average of selected points in that group.
# If no selection: move ALL points; center = average of ALL points.

import c4d
from c4d import gui

def get_threshold(default=0.1):
    txt = gui.InputDialog("Threshold (object units)", str(default))
    if txt is None:
        return None
    try:
        return float(txt)
    except ValueError:
        gui.MessageDialog("Please enter a numeric value.")
        return None

def get_selected_indices(obj):
    """Return selected point indices for any PointObject (SplineObject/PolygonObject)."""
    if not isinstance(obj, c4d.PointObject):
        return []
    bs = obj.GetPointS()
    if not bs:
        return []
    cnt = obj.GetPointCount()
    return [i for i in range(cnt) if bs.IsSelected(i)]

def group_and_snap(points, axis_idx, thr, movable_set, use_selected_center):
    """
    Build groups along axis_idx using ALL points with 'thr'.
    For each group:
      - target = avg(SELECTED points in group) if use_selected_center and any exist,
                 else avg(ALL points in group).
      - move only indices in movable_set.
    """
    if not points:
        return points

    # Collect (axis_value, index) for ALL points
    vals = []
    for i, p in enumerate(points):
        v = p.x if axis_idx == 0 else p.y if axis_idx == 1 else p.z
        vals.append((v, i))
    vals.sort(key=lambda t: t[0])

    # Group contiguous values within threshold
    groups = []
    cur = [vals[0]]
    seed = vals[0][0]
    for v, idx in vals[1:]:
        if abs(v - seed) <= thr:
            cur.append((v, idx))
        else:
            groups.append(cur)
            cur = [(v, idx)]
        seed = v
    groups.append(cur)

    new_pts = list(points)
    for grp in groups:
        if len(grp) < 2:
            continue  # ignore singletons to avoid accidental nudges

        sel_vals = [(v, i) for (v, i) in grp if i in movable_set] if use_selected_center else []
        if use_selected_center and sel_vals:
            target = sum(v for v, _ in sel_vals) / float(len(sel_vals))
        else:
            target = sum(v for v, _ in grp) / float(len(grp))

        for _, i in grp:
            if i not in movable_set:
                continue
            p = c4d.Vector(new_pts[i])
            if axis_idx == 0:   p.x = target
            elif axis_idx == 1: p.y = target
            else:               p.z = target
            new_pts[i] = p

    return new_pts

def process_point_object(po, thr):
    if not isinstance(po, c4d.PointObject):
        return False

    pts = list(po.GetAllPoints())
    if not pts:
        return False

    sel = set(get_selected_indices(po))
    if sel:
        movable = sel                       # move only selected
        use_selected_center = True          # centers from selected-only
    else:
        movable = set(range(len(pts)))      # move all
        use_selected_center = False         # centers from all points

    # Align along X -> Y -> Z
    pts = group_and_snap(pts, 0, thr, movable, use_selected_center)
    pts = group_and_snap(pts, 1, thr, movable, use_selected_center)
    pts = group_and_snap(pts, 2, thr, movable, use_selected_center)

    po.SetAllPoints(pts)
    po.Message(c4d.MSG_UPDATE)
    return True

def main():
    doc = c4d.documents.GetActiveDocument()
    thr = get_threshold(0.1)
    if thr is None:
        return

    # Work on selected PointObjects (incl. children); else, active if it's a PointObject
    targets = [o for o in doc.GetActiveObjects(c4d.GETACTIVEOBJECTFLAGS_CHILDREN)
               if isinstance(o, c4d.PointObject)]
    if not targets:
        o = doc.GetActiveObject()
        if isinstance(o, c4d.PointObject):
            targets = [o]
        else:
            gui.MessageDialog("Select at least one spline or polygon object.")
            return

    doc.StartUndo()
    try:
        changed = 0
        for obj in targets:
            doc.AddUndo(c4d.UNDOTYPE_CHANGE, obj)
            if process_point_object(obj, thr):
                changed += 1
        if changed == 0:
            gui.MessageDialog("No points were modified. Check your selections and threshold.")
    finally:
        doc.EndUndo()
        c4d.EventAdd()

if __name__ == "__main__":
    main()
